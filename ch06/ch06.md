# 第六章 度量和控制架构特征

架构师必须在软件项目的所有不同方面处理非常广泛的架构特征。操作方面(如性能、弹性和可伸缩性)与结构方面(如模块化和可部署性)结合在一起。本章着重于具体定义一些更常见的架构特征，并为它们构建治理机制。

## 测量架构特征

围绕组织架构特征的定义存在几个常见问题:

*他们不是物理*
许多常用的架构特性含义模糊。例如，架构师如何设计敏捷性或可部署性?行业对共同术语的看法大相径庭，有时是出于合理的不同背景，有时是出于偶然。

*变化多端的定义*
即使在同一个组织中，不同的部门可能对关键特性(如性能)的定义存在分歧。除非开发人员、架构和操作人员能够统一在一个通用的定义上，否则很难进行适当的对话。

*太复合*
许多理想的架构特性包含许多较小规模的其他特性。例如，开发人员可以将敏捷性分解为模块化、可部署性和可测试性等特征。

架构特征的目标定义解决了所有三个问题:通过在整个组织范围内对架构特征的具体定义达成一致，团队围绕架构创建了一种普遍存在的语言。此外，通过鼓励客观定义，团队可以分解复合特征，以发现他们可以客观定义的可测量特征。

### 操作措施

许多架构特征具有明显的直接度量，例如性能或可伸缩性。然而，根据团队的目标，这些也提供了许多微妙的解释。例如，团队可能会度量特定请求的平均响应时间，这是一个很好的操作性架构特征度量的例子。但是，如果团队只测量平均值，如果某些边界条件导致1%的请求比其他请求多花10倍的时间，会发生什么呢?如果网站有足够的流量，这些异常值甚至可能不会出现。因此，团队可能还想度量最大响应时间以捕获异常值。

------

#### 表演的多种风格

我们描述的许多架构特征都有多个微妙的定义。性能就是一个很好的例子。许多项目关注的是总体性能:例如，web应用程序的请求和响应周期多长。然而，架构师和DevOps工程师已经在建立性能预算方面做了大量的工作:为应用程序的特定部分制定特定的预算。例如，许多组织研究了用户行为，并确定首页呈现的最佳时间(网页在浏览器或移动设备上的第一个可见的进展迹象)是500ms——半秒;大多数申请都在两位数范围内。但是，对于试图捕获尽可能多的用户的现代站点来说，这是一个重要的跟踪指标，而它们背后的组织已经建立了非常微妙的衡量标准。

其中一些指标对应用程序的设计有额外的含义。许多有远见的组织将K-weight预算用于页面下载:特定页面上允许的库和框架的最大字节数。这种结构背后的原理来自于物理约束:在一个网络中一次只能传输这么多字节，特别是对于处于高延迟区域的移动设备。

------

高水平的团队不只是建立硬性的业绩数据;他们的定义是基于统计分析的。例如，视频流服务希望监控可伸缩性。工程师们不是设定一个任意的数字作为目标，而是随着时间的推移测量规模并建立统计模型，然后在实时指标超出预测模型时发出警报。失败可能意味着两件事：模型是不正确的（这是团队想要知道的），或者有些东西是错误的（这也是团队想要知道的）。

团队现在可以衡量的特征类型正在迅速发展，同时还伴随着工具和微妙的理解。例如，许多团队最近都在关注性能预算指标，如第一次内容绘制和第一次CPU空闲，这两项指标都说明了移动设备上的网页用户的性能问题。随着设备、目标、能力和无数其他事物的变化，团队将发现新的事物和测量方法。

### 构造措施

一些客观的衡量标准不如业绩那么明显。内部结构特征呢，比如定义良好的模块化?不幸的是，内部代码质量的综合度量还不存在。然而，一些度量标准和通用工具确实允许架构师处理代码结构的一些关键方面，尽管是在狭窄的维度上。

代码的一个明显可测量的方面是复杂度，由*圈复杂度*指标定义。

------

圈复杂度
圈复杂度（Cyclomatic Complexity）](https://oreil.ly/mAHFZ)是一个代码级别的度量，旨在为函数/方法、类或应用程序级别的代码复杂度提供一个对象度量，由Thomas McCabe, Sr.在1976年开发。

它是通过将图论应用到代码中来计算的，特别是决策点，它会导致不同的执行路径。例如，如果一个函数没有决策语句(如`if`语句)，那么`CC = 1`。如果函数只有一个条件，那么`CC = 2`，因为存在两个可能的执行路径。

计算单个函数或方法的CC的公式是$CC=E-N+2$，其中$N$表示节点(代码行)，$E$表示边(可能的决策)。考虑例6-1中显示的类C代码。

例6-1 圈复杂度评估的示例代码

```c
public void decision(int c1, int c2) {
    if (c1 < 100)
        return 0;
    else if (c1 + c2 > 500)
       return 1;
    else
      return -1;
}
```

例6-1的圈复杂度为3 (=3 - 2 + 2);如图6-1所示。

![fosa_0601](./images/fosa_0601.png)